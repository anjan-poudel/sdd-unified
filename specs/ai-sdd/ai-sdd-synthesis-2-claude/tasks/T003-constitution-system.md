# T003: Constitution System — Recursive Context Resolution

**Phase:** 1 (Core Engine)
**Status:** PENDING
**Dependencies:** none
**Changes from synthesized-claude:** Added artifact manifest section + manifest writer; added sub-module inheritance exclusion rule for AUTO-GENERATED sections.

---

## Context

A "constitution" is a set of steering files (purpose, background, rules, standards) that define the operational context for a project or sub-module. Constitutions are hierarchical: a sub-module's constitution overrides its parent, which overrides the project root, which overrides the framework defaults.

At task execution time, the engine merges the active constitution chain into the agent's system prompt, ensuring agents operate within the correct context.

The constitution also serves as the **context management mechanism**: the engine auto-writes a `## Workflow Artifacts` manifest section after each task completes. Agents use this manifest — together with their native tools (Read, Grep, Serena) — to pull only the artifacts they need. No ContextReducer; no engine-side context compression.

---

## Acceptance Criteria

```gherkin
Feature: Constitution resolver

  Scenario: Project root constitution is loaded
    Given a project with .ai-sdd/constitution.md at the root
    When a task runs from the project root
    Then the root constitution is included in the agent context

  Scenario: Sub-module constitution overrides root
    Given a project root constitution with rule "use Python 3.11"
    And a sub-module constitution with rule "use Python 3.12"
    When a task runs from within the sub-module
    Then the merged constitution contains "use Python 3.12" (sub-module wins)
    And other root rules not overridden by the sub-module are preserved

  Scenario: Framework defaults are base layer
    Given a project with no constitution files at all
    When a task runs
    Then the framework default context is used
    And no error is raised

  Scenario: Deep nesting
    Given constitutions at: framework → project root → src/ → src/auth/
    When a task runs inside src/auth/
    Then all four layers are merged in order (framework < root < src < src/auth)

  Scenario: Artifact manifest written after task completes
    Given task "define-requirements" completes and produces requirements.md
    When the engine post-task hook fires
    Then the "## Workflow Artifacts" section in constitution.md is updated
    And requirements.md appears with status COMPLETED

  Scenario: AUTO-GENERATED sections not inherited by sub-modules
    Given a root constitution.md with a "## Workflow Artifacts" AUTO-GENERATED section
    When a sub-module task runs
    Then the sub-module merges human-written sections from root
    But the AUTO-GENERATED artifact manifest is NOT merged into sub-module context
    (The manifest is only meaningful at project root level)

  Scenario: Manifest section is idempotent
    Given the manifest writer runs twice on the same state
    Then the constitution.md contains exactly one manifest section
    And the second run replaces the first (not appends)
```

---

## Constitution File Format

```markdown
# constitution.md

## Purpose
[Why this project/module exists and what it's trying to achieve]

## Background
[Domain context, key constraints, technology choices and rationale]

## Rules
- [Hard rule 1 — these must be followed]
- [Hard rule 2]

## Standards
- Code style: [...]
- Testing: [...]
- Naming: [...]
- Documentation: [...]

## Agent Roles
[Optional: describe the SDD agent roles active in this project]

## Reading Convention
Read only the artifacts relevant to your current task using your native tools.
Do not pre-load all artifacts.

<!-- The section below is AUTO-GENERATED by the engine — do not edit manually -->
## Workflow Artifacts
| Task | Artifact | Path | Status |
|---|---|---|---|
| define-requirements | Requirements doc | .ai-sdd/outputs/requirements.md | COMPLETED |
| design-l1 | L1 Architecture | .ai-sdd/outputs/design/l1.md | PENDING |
```

---

## Resolution Algorithm

Resolution order (lowest priority first — highest wins):
1. Framework default context (`config/defaults.yaml` context section)
2. Project root `constitution.md`
3. Each intermediate directory's `constitution.md` walking toward the task
4. Task-specific directory `constitution.md` (closest to the task)

Merge strategy:
- **Purpose / Background**: child overrides parent completely (replace).
- **Rules / Standards**: append child rules; if child re-states a rule, child version takes precedence.
- **AUTO-GENERATED sections** (`## Workflow Artifacts`, `## Reading Convention`): project root only — never merged into sub-module constitutions.

---

## Inputs

- Project root path
- Task execution path (to determine which sub-module constitutions apply)
- Workflow state (for manifest writer — post-task hook)

## Outputs

- Merged constitution string (injected as system prompt context)
- Resolution trace (list of files merged in order, for observability)
- Updated `constitution.md` with current artifact manifest (post-task)

---

## Implementation Notes

- Walk directory tree upward from task path to project root, collecting `constitution.md` files.
- Apply merge in bottom-up order (framework → root → closest sub-module).
- Cache resolved constitutions per path to avoid re-reading on repeated dispatches.
- Constitution resolution trace emitted as a `constitution.resolved` observability event.
- `manifest_writer.py` registers on the engine's `on_post_task("*")` hook.
- Manifest write uses begin/end HTML comment markers for idempotent replacement.
- Manifest write failure: emit warning and continue — it is observability, not state.

---

## Files to Create

- `constitution/resolver.py`
- `constitution/manifest_writer.py`
- `constitution/schema.yaml`
- `config/defaults.yaml` (includes framework-level default context section)
- `tests/test_constitution_resolver.py`
- `tests/test_manifest_writer.py`

---

## Test Strategy

- Unit tests: single load, two-level override, deep nesting, missing files (graceful fallback).
- Unit tests: merge strategy for Rules/Standards sections.
- Unit tests: AUTO-GENERATED sections excluded from sub-module merge.
- Unit tests: manifest writer — idempotent (run twice → one section); missing constitution created.
- Integration test: constitution injected correctly into agent context bundle.
- Integration test: manifest updated after each task in a full workflow run.

## Rollback/Fallback

- **Project root `constitution.md` malformed**: hard startup error — "root constitution is
  malformed; fix before running". Silently dropping the root layer could silently remove
  governance rules. Fail fast.
- **Submodule `constitution.md` malformed**: warn and skip that layer. Submodule layers
  are supplemental; dropping one is lower-risk than dropping the root.
- To allow permissive mode for all layers (e.g. gradual adoption): set
  `constitution.strict_parse: false` in `ai-sdd.yaml`. Off by default for new projects.
- Manifest write failure: log warning, continue — manifest is observability, not state.
